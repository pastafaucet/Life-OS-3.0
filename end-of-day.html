<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End of Day Review - Legal Task Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
            background-color: #000000;
            color: #ffffff;
            line-height: 1.5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header Navigation */
        .header {
            background-color: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
        }

        .view-tabs {
            display: flex;
            gap: 4px;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 4px;
        }

        .view-tab {
            padding: 8px 16px;
            border-radius: 6px;
            color: #9ca3af;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            background: none;
            text-decoration: none;
        }

        .view-tab.active {
            background: #8b5cf6;
            color: #ffffff;
        }

        .view-tab:not(.active):hover {
            color: #ffffff;
            background: #2a2a2a;
        }

        /* End of Day Header */
        .end-of-day-header {
            background-color: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
        }

        .date-title {
            font-size: 32px;
            font-weight: 700;
            color: #8b5cf6;
            margin-bottom: 16px;
        }

        .header-info {
            display: flex;
            justify-content: center;
            gap: 32px;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            color: #9ca3af;
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background-color: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Priority Status */
        .priority-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .priority-status.completed {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .priority-status.partial {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .priority-status.incomplete {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .priority-text {
            font-size: 18px;
            font-weight: 600;
        }

        .priority-text.completed { color: #22c55e; }
        .priority-text.partial { color: #f59e0b; }
        .priority-text.incomplete { color: #ef4444; }

        .priority-count {
            font-size: 24px;
            font-weight: 700;
        }

        /* Task Lists */
        .task-item {
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .task-checkbox {
            width: 16px;
            height: 16px;
            background: none;
            border: 1px solid #4a5568;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .task-checkbox.checked {
            background: #4ade80;
            border-color: #4ade80;
            color: #ffffff;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 6px;
            color: #ffffff;
        }

        .task-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .badge-client { background: rgba(59, 130, 246, 0.1); color: #60a5fa; }
        .badge-case { background: rgba(236, 72, 153, 0.1); color: #f472b6; }
        .badge-priority { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .badge-type { background: rgba(34, 197, 94, 0.1); color: #4ade80; }

        /* Editable Date Badge */
        .badge-date {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            position: relative;
            cursor: pointer;
        }

        .badge-date:hover {
            background: rgba(251, 191, 36, 0.2);
        }

        .badge-date.tomorrow {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
        }

        .badge-date.overdue {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Date Picker Dropdown */
        .date-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 8px 0;
            min-width: 120px;
            z-index: 100;
            display: none;
        }

        .date-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            color: #ffffff;
            transition: background 0.2s ease;
        }

        .date-option:hover {
            background: #2a2a2a;
        }

        /* Time Summary */
        .time-summary {
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .time-row:last-child {
            margin-bottom: 0;
        }

        .time-label {
            color: #9ca3af;
        }

        .time-value {
            font-weight: 600;
            color: #ffffff;
        }

        .time-value.success { color: #4ade80; }
        .time-value.warning { color: #fbbf24; }

        /* Priority Selection */
        .priority-selection {
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .priority-instruction {
            color: #9ca3af;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .tomorrow-task {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .tomorrow-task:hover {
            border-color: #fbbf24;
        }

        .tomorrow-task.priority {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.05);
        }

        .priority-star {
            width: 24px;
            height: 24px;
            background: none;
            border: 1px solid #6b7280;
            border-radius: 4px;
            color: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .priority-star.active {
            background: #fbbf24;
            border-color: #fbbf24;
            color: #000000;
        }

        .task-info {
            flex: 1;
        }

        .task-duration {
            color: #9ca3af;
            font-size: 12px;
            margin-top: 4px;
        }

        /* Reflection Section */
        .reflection-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .rating-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rating-bar {
            width: 200px;
            height: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .rating-fill {
            height: 100%;
            background: linear-gradient(to right, #ef4444, #fbbf24, #4ade80);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .rating-value {
            color: #ffffff;
            font-weight: 600;
            min-width: 40px;
        }

        .reflection-input {
            width: 100%;
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 12px;
            color: #ffffff;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            margin-top: 8px;
        }

        .reflection-input:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn.primary {
            background: #8b5cf6;
            color: #ffffff;
        }

        .action-btn.secondary {
            background: #374151;
            color: #9ca3af;
            border: 1px solid #4b5563;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #9ca3af;
        }

        /* Calendar Picker */
        .calendar-picker {
            position: fixed;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 16px;
            min-width: 280px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-nav {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .calendar-nav:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .calendar-month-year {
            color: #ffffff;
            font-weight: 600;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .calendar-weekday {
            width: 32px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 11px;
            font-weight: 500;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .calendar-day.today {
            background: #8b5cf6;
            color: #ffffff;
        }

        .calendar-day.selected {
            background: #fbbf24;
            color: #000000;
        }

        .calendar-day.other-month {
            color: #4b5563;
        }

        /* Full width bottom section */
        .full-width-section {
            background-color: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üåÜ Legal Task Manager</h1>
            <div class="view-tabs">
                <a href="unified-legal-tasks.html" class="view-tab">üìä Command Center</a>
                <a href="unified-legal-tasks.html?view=task-entry" class="view-tab">‚úèÔ∏è Task Entry</a>
                <a href="start-of-day.html" class="view-tab">üåÖ Start of Day</a>
                <a href="end-of-day.html" class="view-tab active">üåô End of Day</a>
            </div>
        </div>

        <!-- Date and Header Info -->
        <div class="end-of-day-header">
            <div class="date-title" id="currentDate"></div>
            <div class="header-info">
                <div class="info-item">
                    <span>‚è∞</span>
                    <span id="currentTime"></span>
                </div>
                <div class="info-item">
                    <span>‚è±Ô∏è</span>
                    <span id="totalLoggedTime">0m Total Logged</span>
                </div>
                <div class="info-item">
                    <span>üìä</span>
                    <span id="dayProgress">Day Progress</span>
                </div>
            </div>
        </div>

        <!-- Main Grid: Accountability & Tomorrow Setup -->
        <div class="main-grid">
            <!-- Today's Accountability -->
            <div class="card">
                <h2 class="card-title">üìà Today's Accountability</h2>
                
                <!-- Priority Status -->
                <div id="priorityStatusCard" class="priority-status">
                    <div class="priority-text">Priorities Complete</div>
                    <div class="priority-count" id="priorityCount">0/3</div>
                </div>

                <!-- Time Summary -->
                <div class="time-summary">
                    <div class="time-row">
                        <span class="time-label">Tasks Completed:</span>
                        <span class="time-value" id="tasksCompleted">0 of 0</span>
                    </div>
                    <div class="time-row">
                        <span class="time-label">Events Attended:</span>
                        <span class="time-value" id="eventsAttended">0 of 0</span>
                    </div>
                    <div class="time-row">
                        <span class="time-label">Deadlines Met:</span>
                        <span class="time-value" id="deadlinesMet">0 of 0</span>
                    </div>
                    <div class="time-row">
                        <span class="time-label">Time Logged:</span>
                        <span class="time-value" id="timeLogged">0m</span>
                    </div>
                </div>

                <!-- Incomplete Tasks -->
                <div>
                    <h3 style="color: #ffffff; margin-bottom: 12px;" id="incompleteTasksTitle">Incomplete Tasks</h3>
                    <div id="incompleteTasks"></div>
                </div>
            </div>

            <!-- Tomorrow Setup -->
            <div class="card">
                <h2 class="card-title">üîÑ Tomorrow Setup</h2>
                
                <!-- Rollover Tasks -->
                <div>
                    <h3 style="color: #ffffff; margin-bottom: 12px;" id="rolloverTitle">Reschedule Tasks</h3>
                    <div style="color: #9ca3af; font-size: 14px; margin-bottom: 16px;">
                        ‚úÖ Check tasks to reschedule ‚Ä¢ üìÖ Click date to change when
                    </div>
                    <div id="rolloverTasks"></div>
                </div>

                <!-- Tomorrow Priorities -->
                <div class="priority-selection">
                    <h3 style="color: #ffffff; margin-bottom: 8px;" id="tomorrowPriorityTitle">Set Tomorrow's 3 Priorities</h3>
                    <div class="priority-instruction">‚≠ê Click stars to select your top 3 focus items for tomorrow</div>
                    <div id="tomorrowTaskList"></div>
                </div>

                <!-- Tomorrow's Preview -->
                <div style="margin-top: 20px;">
                    <h3 style="color: #ffffff; margin-bottom: 12px;" id="tomorrowPreviewTitle">Tomorrow's Schedule</h3>
                    <div id="tomorrowPreview"></div>
                </div>
            </div>
        </div>

        <!-- Quick Reflection - Full Width -->
        <div class="full-width-section">
            <h2 class="card-title">üí≠ Quick Close</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; align-items: center;">
                <!-- Rating -->
                <div>
                    <div class="reflection-row">
                        <span style="color: #ffffff;">How was today?</span>
                        <span class="rating-value" id="productivityRating">Rate your day</span>
                    </div>
                    <div class="rating-container">
                        <div class="rating-bar" onclick="setProductivityRating(event)">
                            <div class="rating-fill" id="productivityFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Key Insight -->
                <div>
                    <label style="color: #ffffff; display: block; margin-bottom: 8px;">Key insight or takeaway:</label>
                    <textarea class="reflection-input" id="keyInsight" placeholder="What did you learn today?" style="height: 80px;"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons" style="margin-top: 0;">
                    <button class="action-btn primary" onclick="saveAndCloseDay()">Save & Close Day</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Storage and utility classes
        class TaskStorage {
            static get() {
                const data = localStorage.getItem('legalTasks');
                return data ? JSON.parse(data) : { tasks: [], nextId: 1 };
            }

            static save(data) {
                localStorage.setItem('legalTasks', JSON.stringify(data));
            }

            static updateTask(id, updates) {
                const data = this.get();
                const taskIndex = data.tasks.findIndex(t => t.id === id);
                if (taskIndex !== -1) {
                    data.tasks[taskIndex] = { ...data.tasks[taskIndex], ...updates };
                    this.save(data);
                }
            }
        }

        // Date utilities
        class DateUtils {
            static formatDateForDisplay(dateString) {
                if (!dateString) return '';
                
                const today = new Date();
                const todayStr = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear()}`;
                
                const dateOnly = dateString.split(' ')[0];
                
                if (dateOnly === todayStr) {
                    const timePart = dateString.includes(' ') ? ' ' + dateString.split(' ').slice(1).join(' ') : '';
                    return 'today' + timePart;
                }
                
                return dateString;
            }

            static isToday(dateString) {
                if (!dateString) return false;
                
                const today = new Date();
                const todayFormats = [
                    today.toISOString().split('T')[0],
                    today.toLocaleDateString(),
                    'today',
                    today.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase()
                ];

                return todayFormats.some(format => 
                    dateString.toLowerCase().includes(format.toLowerCase())
                );
            }

            static isOverdue(dateString) {
                if (!dateString) return false;
                
                try {
                    let taskDate = new Date(dateString);
                    
                    if (isNaN(taskDate)) {
                        const parts = dateString.match(/(\d{1,2})[-\/](\d{1,2})(?:[-\/](\d{2,4}))?/);
                        if (parts) {
                            const month = parseInt(parts[1]) - 1;
                            const day = parseInt(parts[2]);
                            const year = parts[3] ? parseInt(parts[3]) : new Date().getFullYear();
                            taskDate = new Date(year < 100 ? year + 2000 : year, month, day);
                        }
                    }
                    
                    if (!isNaN(taskDate)) {
                        taskDate.setHours(23, 59, 59, 999);
                        return taskDate < new Date();
                    }
                } catch (e) {
                    return false;
                }
                
                return false;
            }

            static getTomorrowDate() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                return `${tomorrow.getMonth() + 1}/${tomorrow.getDate()}/${tomorrow.getFullYear()}`;
            }

            static getNextWeekDate() {
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                return `${nextWeek.getMonth() + 1}/${nextWeek.getDate()}/${nextWeek.getFullYear()}`;
            }

            static getNextMondayDate() {
                const date = new Date();
                const day = date.getDay();
                const nextMonday = new Date(date);
                nextMonday.setDate(date.getDate() + ((1 + 7 - day) % 7 || 7));
                return `${nextMonday.getMonth() + 1}/${nextMonday.getDate()}/${nextMonday.getFullYear()}`;
            }
        }

        // End of Day UI Manager
        class EndOfDayUI {
            constructor() {
                this.tomorrowPriorities = [];
                this.init();
                this.render();
            }

            init() {
                // Initialize date and time
                const now = new Date();
                document.getElementById('currentDate').textContent = 
                    `üåô ${now.toLocaleDateString('en-US', { 
                        weekday: 'long',
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}`;
                
                document.getElementById('currentTime').textContent = 
                    now.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
            }

            getTypeIcon(type) {
                const typeIcons = {
                    'deadline': '‚è∞',
                    'event': 'üìÖ',
                    'meeting': 'üë•',
                    'call': 'üìû',
                    'research': 'üîç',
                    'filing': 'üìã',
                    'review': 'üëÅÔ∏è',
                    'client': 'ü§ù',
                    'admin': '‚öôÔ∏è'
                };
                return typeIcons[type] || 'üìå';
            }

            formatDuration(minutes) {
                if (minutes < 60) {
                    return `${minutes}m`;
                } else {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
                }
            }

            render() {
                const data = TaskStorage.get();
                this.renderAccountability(data);
                this.renderTomorrowSetup(data);
            }

            renderAccountability(data) {
                // Get today's priorities (tasks with dayPriority)
                const todaysPriorities = data.tasks.filter(task => 
                    task.dayPriority && task.dayPriority >= 1 && task.dayPriority <= 3
                );

                const completedPriorities = todaysPriorities.filter(task => task.completed);
                const priorityCount = `${completedPriorities.length}/${todaysPriorities.length}`;
                
                document.getElementById('priorityCount').textContent = priorityCount;
                
                // Update priority status styling
                const priorityCard = document.getElementById('priorityStatusCard');
                const priorityText = priorityCard.querySelector('.priority-text');
                
                if (completedPriorities.length === todaysPriorities.length && todaysPriorities.length > 0) {
                    priorityCard.className = 'priority-status completed';
                    priorityText.className = 'priority-text completed';
                    priorityText.textContent = 'All Priorities Complete! üéâ';
                } else if (completedPriorities.length > 0) {
                    priorityCard.className = 'priority-status partial';
                    priorityText.className = 'priority-text partial';
                    priorityText.textContent = 'Priorities Partial';
                } else {
                    priorityCard.className = 'priority-status incomplete';
                    priorityText.className = 'priority-text incomplete';
                    priorityText.textContent = 'Priorities Incomplete';
                }

                // Calculate task completion
                const todaysTasks = data.tasks.filter(task => 
                    DateUtils.isToday(task.doDate) && task.type !== 'event'
                );
                const completedTasks = todaysTasks.filter(task => task.completed);
                document.getElementById('tasksCompleted').textContent = `${completedTasks.length} of ${todaysTasks.length}`;

                // Calculate event attendance
                const todaysEvents = data.tasks.filter(task => 
                    task.type === 'event' && DateUtils.isToday(task.doDate)
                );
                const attendedEvents = todaysEvents.filter(event => event.completed);
                document.getElementById('eventsAttended').textContent = `${attendedEvents.length} of ${todaysEvents.length}`;

                // Calculate deadlines met
                const todaysDeadlines = data.tasks.filter(task => 
                    task.type === 'deadline' && DateUtils.isToday(task.doDate)
                );
                const metDeadlines = todaysDeadlines.filter(deadline => deadline.completed);
                document.getElementById('deadlinesMet').textContent = `${metDeadlines.length} of ${todaysDeadlines.length}`;

                // Calculate time logged
                const totalSeconds = data.tasks
                    .filter(task => task.timerElapsed && task.timerElapsed > 0)
                    .reduce((total, task) => total + (task.timerElapsed || 0), 0);
                
                const timeLogged = this.formatDuration(Math.floor(totalSeconds / 60));
                document.getElementById('timeLogged').textContent = timeLogged;
                document.getElementById('totalLoggedTime').textContent = `${timeLogged} Total Logged`;

                // Update day progress
                const totalPlanned = todaysTasks.length + todaysEvents.length;
                const totalCompleted = completedTasks.length + attendedEvents.length;
                const progressPercent = totalPlanned > 0 ? Math.round((totalCompleted / totalPlanned) * 100) : 100;
                document.getElementById('dayProgress').textContent = `${progressPercent}% Complete`;

                // Show incomplete tasks
                const incompleteTasks = todaysTasks.filter(task => !task.completed);
                const incompleteContainer = document.getElementById('incompleteTasks');
                const incompleteTitle = document.getElementById('incompleteTasksTitle');
                
                incompleteTitle.textContent = `Incomplete Tasks (${incompleteTasks.length})`;

                if (incompleteTasks.length === 0) {
                    incompleteContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>‚úÖ All Tasks Complete!</h3>
                            <p>Great work today</p>
                        </div>
                    `;
                } else {
                    incompleteContainer.innerHTML = incompleteTasks.slice(0, 5).map(task => `
                        <div class="task-item">
                            <div class="task-content">
                                <div class="task-title">${task.title || 'Untitled task'}</div>
                                <div class="task-badges">
                                    ${task.type ? `<span class="task-badge badge-type">${this.getTypeIcon(task.type)}${task.type}</span>` : ''}
                                    <span class="task-badge badge-priority">!${task.priority}</span>
                                    ${task.client ? `<span class="task-badge badge-client">@${task.client}</span>` : ''}
                                    ${task.case ? `<span class="task-badge badge-case">#${task.case}</span>` : ''}
                                    ${task.doDate ? `<span class="task-badge badge-date">üìÖ ${DateUtils.formatDateForDisplay(task.doDate)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            renderTomorrowSetup(data) {
                // Get rollover candidates (incomplete tasks from today or overdue)
                const rolloverCandidates = data.tasks.filter(task => 
                    !task.completed && 
                    task.type !== 'event' && 
                    (DateUtils.isToday(task.doDate) || DateUtils.isOverdue(task.doDate))
                );

                const rolloverContainer = document.getElementById('rolloverTasks');
                const rolloverTitle = document.getElementById('rolloverTitle');
                
                rolloverTitle.textContent = `Reschedule Tasks (${rolloverCandidates.length})`;

                if (rolloverCandidates.length === 0) {
                    rolloverContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>üéâ Nothing to reschedule!</h3>
                            <p>All tasks were completed or are scheduled for future dates</p>
                        </div>
                    `;
                } else {
                    rolloverContainer.innerHTML = rolloverCandidates.map(task => `
                        <div class="task-item">
                            <button class="task-checkbox" onclick="toggleRollover(${task.id})">
                            </button>
                            <div class="task-content">
                                <div class="task-title">${task.title || 'Untitled task'}</div>
                                <div class="task-badges">
                                    ${task.type ? `<span class="task-badge badge-type">${this.getTypeIcon(task.type)}${task.type}</span>` : ''}
                                    <span class="task-badge badge-priority">!${task.priority}</span>
                                    ${task.client ? `<span class="task-badge badge-client">@${task.client}</span>` : ''}
                                    ${task.case ? `<span class="task-badge badge-case">#${task.case}</span>` : ''}
                                    <span class="task-badge badge-date ${DateUtils.isOverdue(task.doDate) ? 'overdue' : ''}" onclick="showDatePicker(${task.id}, event)">
                                        üìÖ ${DateUtils.isOverdue(task.doDate) ? 'overdue' : 'tomorrow'}
                                        <div class="date-dropdown" id="dropdown-${task.id}">
                                            <div class="date-option" onclick="updateTaskDate(${task.id}, 'tomorrow')">Tomorrow</div>
                                            <div class="date-option" onclick="updateTaskDate(${task.id}, 'monday')">Monday</div>
                                            <div class="date-option" onclick="updateTaskDate(${task.id}, 'next-week')">Next Week</div>
                                            <div class="date-option" onclick="showCalendarPicker(${task.id}, event)">üìÖ Pick Date...</div>
                                        </div>
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Render tomorrow priority selection
                this.renderTomorrowPriorities(data, rolloverCandidates);
                
                // Render tomorrow's preview
                this.renderTomorrowPreview(data);
            }

            renderTomorrowPriorities(data, rolloverCandidates) {
                // Get candidates for tomorrow priorities (rollover + future tasks)
                const tomorrowCandidates = [
                    ...rolloverCandidates,
                    ...data.tasks.filter(task => 
                        !task.completed && 
                        task.type !== 'event' && 
                        (task.priority === 'critical' || task.priority === 'important') &&
                        !DateUtils.isToday(task.doDate) &&
                        !DateUtils.isOverdue(task.doDate)
                    )
                ].slice(0, 10); // Limit to 10 candidates

                const priorityContainer = document.getElementById('tomorrowTaskList');
                const priorityTitle = document.getElementById('tomorrowPriorityTitle');
                
                priorityTitle.textContent = `Set Tomorrow's 3 Priorities (${this.tomorrowPriorities.length}/3)`;

                if (tomorrowCandidates.length === 0) {
                    priorityContainer.innerHTML = `
                        <div class="empty-state">
                            <p>No tasks available for priority selection</p>
                            <p style="font-size: 12px;">Add tasks in Command Center</p>
                        </div>
                    `;
                } else {
                    priorityContainer.innerHTML = tomorrowCandidates.map(task => `
                        <div class="tomorrow-task" onclick="toggleTomorrowPriority(${task.id})">
                            <button class="priority-star">‚òÜ</button>
                            <div class="task-info">
                                <div class="task-title">${task.title || 'Untitled task'}</div>
                                <div class="task-duration">${task.hours || '1h'}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            renderTomorrowPreview(data) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = `${tomorrow.getMonth() + 1}/${tomorrow.getDate()}/${tomorrow.getFullYear()}`;
                
                // Get tomorrow's tasks, events and deadlines
                const tomorrowTasks = data.tasks.filter(task => 
                    task.doDate && (
                        task.doDate.includes(tomorrowStr) ||
                        task.doDate === 'tomorrow' ||
                        task.doDate === DateUtils.getTomorrowDate()
                    )
                );
                
                const tomorrowEvents = tomorrowTasks.filter(task => task.type === 'event');
                const tomorrowDeadlines = tomorrowTasks.filter(task => task.type === 'deadline');
                const tomorrowRegular = tomorrowTasks.filter(task => task.type !== 'event' && task.type !== 'deadline');
                
                const previewContainer = document.getElementById('tomorrowPreview');
                const previewTitle = document.getElementById('tomorrowPreviewTitle');
                
                const totalItems = tomorrowEvents.length + tomorrowDeadlines.length + tomorrowRegular.length;
                previewTitle.textContent = `Tomorrow's Schedule (${totalItems} items)`;
                
                if (totalItems === 0) {
                    previewContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>üìÖ No scheduled items</h3>
                            <p>Tomorrow is wide open</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // Events first
                if (tomorrowEvents.length > 0) {
                    html += `<div style="margin-bottom: 12px;">
                        <h4 style="color: #60a5fa; font-size: 14px; margin-bottom: 8px;">üìÖ Events (${tomorrowEvents.length})</h4>
                        ${tomorrowEvents.map(event => `
                            <div class="task-item" style="margin-bottom: 8px;">
                                <div class="task-content">
                                    <div class="task-title">${event.title || 'Untitled event'}</div>
                                    <div class="task-badges">
                                        <span class="task-badge badge-type">üìÖevent</span>
                                        ${event.client ? `<span class="task-badge badge-client">@${event.client}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }
                
                // Deadlines second
                if (tomorrowDeadlines.length > 0) {
                    html += `<div style="margin-bottom: 12px;">
                        <h4 style="color: #ef4444; font-size: 14px; margin-bottom: 8px;">‚è∞ Deadlines (${tomorrowDeadlines.length})</h4>
                        ${tomorrowDeadlines.map(deadline => `
                            <div class="task-item" style="margin-bottom: 8px;">
                                <div class="task-content">
                                    <div class="task-title">${deadline.title || 'Untitled deadline'}</div>
                                    <div class="task-badges">
                                        <span class="task-badge badge-type">‚è∞deadline</span>
                                        <span class="task-badge badge-priority">!${deadline.priority}</span>
                                        ${deadline.client ? `<span class="task-badge badge-client">@${deadline.client}</span>` : ''}
                                        ${deadline.case ? `<span class="task-badge badge-case">#${deadline.case}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }
                
                // Regular tasks last  
                if (tomorrowRegular.length > 0) {
                    html += `<div>
                        <h4 style="color: #4ade80; font-size: 14px; margin-bottom: 8px;">üìå Tasks (${tomorrowRegular.length})</h4>
                        ${tomorrowRegular.slice(0, 5).map(task => `
                            <div class="task-item" style="margin-bottom: 8px;">
                                <div class="task-content">
                                    <div class="task-title">${task.title || 'Untitled task'}</div>
                                    <div class="task-badges">
                                        ${task.type ? `<span class="task-badge badge-type">${this.getTypeIcon(task.type)}${task.type}</span>` : ''}
                                        <span class="task-badge badge-priority">!${task.priority}</span>
                                        ${task.client ? `<span class="task-badge badge-client">@${task.client}</span>` : ''}
                                        ${task.case ? `<span class="task-badge badge-case">#${task.case}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${tomorrowRegular.length > 5 ? `<p style="color: #9ca3af; font-size: 12px; text-align: center;">... and ${tomorrowRegular.length - 5} more tasks</p>` : ''}
                    </div>`;
                }
                
                previewContainer.innerHTML = html;
            }
        }

        // Global functions
        let rolloverSelections = new Set();
        let endOfDayUI;

        function toggleRollover(taskId) {
            const checkbox = event.target;
            if (rolloverSelections.has(taskId)) {
                rolloverSelections.delete(taskId);
                checkbox.classList.remove('checked');
                checkbox.textContent = '';
            } else {
                rolloverSelections.add(taskId);
                checkbox.classList.add('checked');
                checkbox.textContent = '‚úì';
            }
        }

        function showDatePicker(taskId, event) {
            event.stopPropagation();
            
            // Hide all other dropdowns
            document.querySelectorAll('.date-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
            
            // Show this dropdown
            const dropdown = document.getElementById(`dropdown-${taskId}`);
            dropdown.style.display = 'block';
            
            // Hide on click outside
            setTimeout(() => {
                document.addEventListener('click', function hideDropdown() {
                    dropdown.style.display = 'none';
                    document.removeEventListener('click', hideDropdown);
                });
            }, 100);
        }

        function updateTaskDate(taskId, dateOption) {
            let newDate;
            switch(dateOption) {
                case 'tomorrow':
                    newDate = DateUtils.getTomorrowDate();
                    break;
                case 'monday':
                    newDate = DateUtils.getNextMondayDate();
                    break;
                case 'next-week':
                    newDate = DateUtils.getNextWeekDate();
                    break;
                default:
                    newDate = DateUtils.getTomorrowDate();
            }
            
            TaskStorage.updateTask(taskId, { doDate: newDate });
            endOfDayUI.render();
        }

        function toggleTomorrowPriority(taskId) {
            const taskElement = event.currentTarget;
            const star = taskElement.querySelector('.priority-star');
            const isActive = star.classList.contains('active');
            
            if (isActive) {
                // Remove priority
                star.classList.remove('active');
                star.textContent = '‚òÜ';
                taskElement.classList.remove('priority');
                const index = endOfDayUI.tomorrowPriorities.indexOf(taskId);
                if (index > -1) {
                    endOfDayUI.tomorrowPriorities.splice(index, 1);
                }
                // Update numbers for remaining priorities
                updatePriorityNumbers();
            } else if (endOfDayUI.tomorrowPriorities.length < 3) {
                // Add priority
                star.classList.add('active');
                taskElement.classList.add('priority');
                endOfDayUI.tomorrowPriorities.push(taskId);
                // Update numbers for all priorities
                updatePriorityNumbers();
            }
            
            // Update title
            document.getElementById('tomorrowPriorityTitle').textContent = 
                `Set Tomorrow's 3 Priorities (${endOfDayUI.tomorrowPriorities.length}/3)`;
        }

        function updatePriorityNumbers() {
            // Update star display with stars and numbers like Start of Day
            endOfDayUI.tomorrowPriorities.forEach((taskId, index) => {
                const taskElement = document.querySelector(`[onclick*="toggleTomorrowPriority(${taskId})"]`);
                if (taskElement) {
                    const star = taskElement.querySelector('.priority-star');
                    star.textContent = `‚≠ê${index + 1}`;
                }
            });
        }

        function setProductivityRating(event) {
            const ratingBar = event.target.closest('.rating-bar');
            const rect = ratingBar.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = (clickX / rect.width) * 100;
            const rating = Math.max(1, Math.min(10, Math.ceil(percentage / 10)));
            
            // Update visual
            document.getElementById('productivityFill').style.width = `${rating * 10}%`;
            document.getElementById('productivityRating').textContent = `${rating}/10`;
        }

        function saveAndCloseDay() {
            // Save rollover selections
            rolloverSelections.forEach(taskId => {
                TaskStorage.updateTask(taskId, { doDate: DateUtils.getTomorrowDate() });
            });
            
            // Save tomorrow priorities
            endOfDayUI.tomorrowPriorities.forEach((taskId, index) => {
                TaskStorage.updateTask(taskId, { dayPriority: index + 1 });
            });
            
            // Save reflection
            const insight = document.getElementById('keyInsight').value;
            const rating = document.getElementById('productivityRating').textContent;
            
            if (insight || rating !== 'Rate your day') {
                const reflection = {
                    date: new Date().toISOString(),
                    insight: insight,
                    rating: rating,
                    timestamp: Date.now()
                };
                
                const reflections = JSON.parse(localStorage.getItem('dailyReflections') || '[]');
                reflections.push(reflection);
                localStorage.setItem('dailyReflections', JSON.stringify(reflections));
            }
            
            alert('Day closed successfully! Tomorrow\'s priorities are set. üåÖ');
            
            // Optionally redirect to start of day
            // window.location.href = 'start-of-day.html';
        }

        // Calendar picker functionality
        let currentCalendarTaskId = null;
        let currentCalendarDate = new Date();

        function showCalendarPicker(taskId, event) {
            event.stopPropagation();
            
            // Hide dropdown
            const dropdown = document.getElementById(`dropdown-${taskId}`);
            dropdown.style.display = 'none';
            
            // Remove any existing calendar picker
            const existingCalendar = document.getElementById('calendar-picker-popup');
            if (existingCalendar) {
                existingCalendar.remove();
            }
            
            // Create calendar picker popup
            const calendar = document.createElement('div');
            calendar.id = 'calendar-picker-popup';
            calendar.className = 'calendar-picker';
            
            // Position relative to the clicked badge
            const badge = event.target.closest('.badge-date');
            const rect = badge.getBoundingClientRect();
            calendar.style.top = `${rect.bottom + 5}px`;
            calendar.style.left = `${rect.left}px`;
            
            calendar.innerHTML = `
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeCalendarMonth(${taskId}, -1)">‚Äπ</button>
                    <span class="calendar-month-year" id="calendar-month-year-${taskId}"></span>
                    <button class="calendar-nav" onclick="changeCalendarMonth(${taskId}, 1)">‚Ä∫</button>
                </div>
                <div class="calendar-weekdays">
                    <div class="calendar-weekday">Su</div>
                    <div class="calendar-weekday">Mo</div>
                    <div class="calendar-weekday">Tu</div>
                    <div class="calendar-weekday">We</div>
                    <div class="calendar-weekday">Th</div>
                    <div class="calendar-weekday">Fr</div>
                    <div class="calendar-weekday">Sa</div>
                </div>
                <div class="calendar-grid" id="calendar-grid-${taskId}"></div>
            `;
            
            document.body.appendChild(calendar);
            
            currentCalendarTaskId = taskId;
            currentCalendarDate = new Date();
            
            renderCalendar(taskId);
            
            // Hide on click outside
            setTimeout(() => {
                document.addEventListener('click', function hideCalendar(e) {
                    if (!calendar.contains(e.target)) {
                        calendar.remove();
                        document.removeEventListener('click', hideCalendar);
                    }
                });
            }, 100);
        }

        function changeCalendarMonth(taskId, direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar(taskId);
        }

        function renderCalendar(taskId) {
            const monthYear = document.getElementById(`calendar-month-year-${taskId}`);
            const grid = document.getElementById(`calendar-grid-${taskId}`);
            
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            
            monthYear.textContent = currentCalendarDate.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const today = new Date();
            let html = '';
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === month;
                const isToday = date.toDateString() === today.toDateString();
                
                let classes = 'calendar-day';
                if (!isCurrentMonth) classes += ' other-month';
                if (isToday) classes += ' today';
                
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
                
                html += `<button class="${classes}" onclick="selectCalendarDate('${dateStr}')">${date.getDate()}</button>`;
            }
            
            grid.innerHTML = html;
        }

        function selectCalendarDate(dateStr) {
            TaskStorage.updateTask(currentCalendarTaskId, { doDate: dateStr });
            
            // Hide calendar
            const calendar = document.getElementById('calendar-picker-popup');
            if (calendar) {
                calendar.remove();
            }
            
            endOfDayUI.render();
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            endOfDayUI = new EndOfDayUI();
        });
    </script>
</body>
</html>
